class Qcachegrind < Formula
  desc "Visualize data generated by Cachegrind and Calltree"
  homepage "https://apps.kde.org/kcachegrind/"
  url "https://download.kde.org/stable/release-service/24.05.1/src/kcachegrind-24.05.1.tar.xz"
  sha256 "bf45d66b36d073b5bbf5d7b3ef2ce835a263e94e859da93181a3e839112bd26b"
  license "GPL-2.0-or-later"
  head "https://invent.kde.org/sdk/kcachegrind.git", branch: "master"

  # We don't match versions like 19.07.80 or 19.07.90 where the patch number
  # is 80+ (beta) or 90+ (RC), as these aren't stable releases.
  livecheck do
    url "https://download.kde.org/stable/release-service/"
    regex(%r{href=.*?v?(\d+\.\d+\.(?:(?![89]\d)\d+)(?:\.\d+)*)/?["' >]}i)
  end

  bottle do
    sha256 cellar: :any,                 arm64_sonoma:   "5dd3aa04e7b8955442b7665fbef752b9c17dc688279f285606ebbfd40bd3e8df"
    sha256 cellar: :any,                 arm64_ventura:  "5453b2f318eff1b38994353b2315e2d8c15e1a228bfa9455ae467aea195b2e02"
    sha256 cellar: :any,                 arm64_monterey: "e95093e6726ab9701b791d527b51574f504e283422972c860aebb50f282bb96e"
    sha256 cellar: :any,                 sonoma:         "9af642e0a41516604f1ef25c55405a8fee8e01352c3f3846b3b9adac99a2f5dd"
    sha256 cellar: :any,                 ventura:        "07367fd657bae5c77958f6563521ca5883bbe5a0d86f61c916e41ce102aa8b34"
    sha256 cellar: :any,                 monterey:       "4cdf50afc6e84445f312efbd1ade52440578d951b05fb66f41760b8875c0db07"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "4d4539f118e650b4f0a8db93d80600e9818756cf531775b83d01c22a30790947"
  end

  depends_on "graphviz"
  depends_on "qt"

  fails_with gcc: "5"

  def install
    args = %w[-config release]
    if OS.mac?
      spec = (ENV.compiler == :clang) ? "macx-clang" : "macx-g++"
      args += %W[-spec #{spec}]
    end

    qt = Formula["qt"]
    system qt.opt_bin/"qmake", *args
    system "make"

    if OS.mac?
      prefix.install "qcachegrind/qcachegrind.app"
      bin.install_symlink prefix/"qcachegrind.app/Contents/MacOS/qcachegrind"
    else
      bin.install "qcachegrind/qcachegrind"
    end
  end
end