class Qcachegrind < Formula
  desc "Visualize data generated by Cachegrind and Calltree"
  homepage "https://apps.kde.org/kcachegrind/"
  url "https://download.kde.org/stable/release-service/24.02.2/src/kcachegrind-24.02.2.tar.xz"
  sha256 "1c43099fa42a389e9ff92613b550e6606a9de9d5b57a10a4b08ab513e5a67b9c"
  license "GPL-2.0-or-later"
  head "https://invent.kde.org/sdk/kcachegrind.git", branch: "master"

  # We don't match versions like 19.07.80 or 19.07.90 where the patch number
  # is 80+ (beta) or 90+ (RC), as these aren't stable releases.
  livecheck do
    url "https://download.kde.org/stable/release-service/"
    regex(%r{href=.*?v?(\d+\.\d+\.(?:(?![89]\d)\d+)(?:\.\d+)*)/?["' >]}i)
  end

  bottle do
    sha256 cellar: :any,                 arm64_sonoma:   "b28b95dd70268a6e8592be60307633d66d20a8decba6b9e975be3f8b860dfce2"
    sha256 cellar: :any,                 arm64_ventura:  "e1c0d046acfb6f9e047c8dfd3b8cf721111774f972525aedbf36f555b1cc4e6a"
    sha256 cellar: :any,                 arm64_monterey: "c0e4d9c5e9e53dbd543488b1e5aa3bde00c108708679bc06e2b20dde4f2fea91"
    sha256 cellar: :any,                 sonoma:         "93e39b214f30ca38700be5611a41217e33eb93d9f137906410af0dc2002c52b7"
    sha256 cellar: :any,                 ventura:        "6978c7dcc30259a2931e2b32f148a580ebd385309644f43ba94d98bab10920f9"
    sha256 cellar: :any,                 monterey:       "36b3c81479fd3fe0777e1461eed7b7c065bf9f3769876e791fa1a66bdd6a4849"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "3760a0dea1fc99369316561a1c5f365d6f04ce2c3e3e3d9bc4f3846ad4d1024e"
  end

  depends_on "graphviz"
  depends_on "qt"

  fails_with gcc: "5"

  def install
    args = %w[-config release]
    if OS.mac?
      spec = (ENV.compiler == :clang) ? "macx-clang" : "macx-g++"
      args += %W[-spec #{spec}]
    end

    qt = Formula["qt"]
    system qt.opt_bin/"qmake", *args
    system "make"

    if OS.mac?
      prefix.install "qcachegrind/qcachegrind.app"
      bin.install_symlink prefix/"qcachegrind.app/Contents/MacOS/qcachegrind"
    else
      bin.install "qcachegrind/qcachegrind"
    end
  end
end