class Qcachegrind < Formula
  desc "Visualize data generated by Cachegrind and Calltree"
  homepage "https://apps.kde.org/kcachegrind/"
  license "GPL-2.0-or-later"

  stable do
    url "https://download.kde.org/stable/release-service/23.08.5/src/kcachegrind-23.08.5.tar.xz"
    sha256 "056687b7adb0049db0503738cf95a7051f3b889b3313fa8b78dc7d03c3dbb7b6"
    depends_on "qt@5"
  end

  # We don't match versions like 19.07.80 or 19.07.90 where the patch number
  # is 80+ (beta) or 90+ (RC), as these aren't stable releases.
  livecheck do
    url "https://download.kde.org/stable/release-service/"
    regex(%r{href=.*?v?(\d+\.\d+\.(?:(?![89]\d)\d+)(?:\.\d+)*)/?["' >]}i)
  end

  bottle do
    sha256 cellar: :any,                 arm64_sonoma:   "4fcd3344983b8443033029d2d41dd7f39fc33bc2632ce735888f7edcd37491d3"
    sha256 cellar: :any,                 arm64_ventura:  "4fcd3344983b8443033029d2d41dd7f39fc33bc2632ce735888f7edcd37491d3"
    sha256 cellar: :any,                 arm64_monterey: "c1ef8643fa248ed0aa3e20ebb80404008fb962ce1f63fddb8fb95360dca42634"
    sha256 cellar: :any,                 sonoma:         "47e92eeb71e1d95b2fc01f0e1c8de132651d0dcf8a85082261acf120d6839352"
    sha256 cellar: :any,                 ventura:        "47e92eeb71e1d95b2fc01f0e1c8de132651d0dcf8a85082261acf120d6839352"
    sha256 cellar: :any,                 monterey:       "8a861becb57d02347cf0b052afce9b45b9d57dd2f7fb52d467d6a61a6f0732c5"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "d22fce2f95e1b5f55ca80d9e4627265c8d5067ba5fed4ecb6ecbb977f0098965"
  end

  head do
    url "https://invent.kde.org/sdk/kcachegrind.git", branch: "master"
    depends_on "qt"
  end

  depends_on "graphviz"

  fails_with gcc: "5"

  def install
    args = []
    if OS.mac?
      # TODO: when using qt 6, modify the spec
      spec = (ENV.compiler == :clang) ? "macx-clang" : "macx-g++"
      args = %W[-config release -spec #{spec}]
    end

    qt = Formula[build.head? ? "qt" : "qt@5"]
    system qt.opt_bin/"qmake", *args
    system "make"

    if OS.mac?
      prefix.install "qcachegrind/qcachegrind.app"
      bin.install_symlink prefix/"qcachegrind.app/Contents/MacOS/qcachegrind"
    else
      bin.install "qcachegrind/qcachegrind"
    end
  end
end