class Qcachegrind < Formula
  desc "Visualize data generated by Cachegrind and Calltree"
  homepage "https://kcachegrind.github.io/"
  url "https://download.kde.org/stable/release-service/23.04.2/src/kcachegrind-23.04.2.tar.xz"
  sha256 "9bb17cc9e85e396e8591d06e04974d6f106b1d8de00596af77555afc93915902"
  license "GPL-2.0-or-later"

  # We don't match versions like 19.07.80 or 19.07.90 where the patch number
  # is 80+ (beta) or 90+ (RC), as these aren't stable releases.
  livecheck do
    url "https://download.kde.org/stable/release-service/"
    regex(%r{href=.*?v?(\d+\.\d+\.(?:(?![89]\d)\d+)(?:\.\d+)*)/?["' >]}i)
  end

  bottle do
    sha256 cellar: :any,                 arm64_ventura:  "6c387a89e1863a240e5bad1891ee92dcee37c85cbde9e7be8c3419d6b46f58d8"
    sha256 cellar: :any,                 arm64_monterey: "e94cc59ef4a6f517d8050e8c5239ee9d2c6272be881c7659ed14854d31201889"
    sha256 cellar: :any,                 arm64_big_sur:  "7fed3496b9ee2564c8fa6a62e9903a6fd186bb2efc9ac5f9043522e25391bf49"
    sha256 cellar: :any,                 ventura:        "3a157eeb174663d6382dd07e0afe9ed3e0811d7c39efe7f8ede7718de8806b77"
    sha256 cellar: :any,                 monterey:       "e5e99dbf614dc6a9aeb49c54ccc102ce49d3735fcc0c9d78e654bfaa38d84c44"
    sha256 cellar: :any,                 big_sur:        "419bb8551fa091cd5c5c1d2304bc3521821eb612c868604c14953bf260a01a48"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "693b4bb2b947ab6fd48a7043d3a248e941256f0ab7d8424bb5ce4f25e318170f"
  end

  depends_on "graphviz"
  depends_on "qt@5"

  fails_with gcc: "5"

  def install
    args = []
    if OS.mac?
      # TODO: when using qt 6, modify the spec
      spec = (ENV.compiler == :clang) ? "macx-clang" : "macx-g++"
      args = %W[-config release -spec #{spec}]
    end

    system Formula["qt@5"].opt_bin/"qmake", *args
    system "make"

    if OS.mac?
      prefix.install "qcachegrind/qcachegrind.app"
      bin.install_symlink prefix/"qcachegrind.app/Contents/MacOS/qcachegrind"
    else
      bin.install "qcachegrind/qcachegrind"
    end
  end
end