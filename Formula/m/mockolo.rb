class Mockolo < Formula
  desc "Efficient Mock Generator for Swift"
  homepage "https://github.com/uber/mockolo"
  url "https://ghfast.top/https://github.com/uber/mockolo/archive/refs/tags/2.4.0.tar.gz"
  sha256 "58174327732b53f9e6bb0c8c355270ae2df7be739f006680fd8eeb53599b6766"
  license "Apache-2.0"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sequoia: "b74e8f8747277f43a811197fe8ce144b06b4580a541689dcaf3ce784301b9fdc"
    sha256 cellar: :any_skip_relocation, arm64_sonoma:  "ab85a94f0caf1fa8d1116376af36f713ecd3c1d18ee29a576aa121329ac9252c"
    sha256 cellar: :any_skip_relocation, sonoma:        "3bc1c046167b769698f2629375ec0ece777f759e19bcda17f8a708de58eeabc7"
    sha256 cellar: :any_skip_relocation, arm64_linux:   "afd124d827ae8b9a17e7eadeb2a8360758fbf7809e669e5991cd6d3af3c521fa"
    sha256 cellar: :any_skip_relocation, x86_64_linux:  "668e2e869b2bfce47c71e3c7b4f66f3b61810b7365a5e13e582645cab44d4dc6"
  end

  depends_on xcode: ["15.3", :build]

  uses_from_macos "swift" => :build

  def install
    args = if OS.mac?
      ["--disable-sandbox"]
    else
      ["--static-swift-stdlib"]
    end
    system "swift", "build", *args, "-c", "release", "--product", "mockolo"
    bin.install ".build/release/mockolo"
  end

  test do
    (testpath/"testfile.swift").write <<~SWIFT
      /// @mockable
      public protocol Foo {
          var num: Int { get set }
          func bar(arg: Float) -> String
      }
    SWIFT
    system bin/"mockolo", "-srcs", testpath/"testfile.swift", "-d", testpath/"GeneratedMocks.swift"
    assert_path_exists testpath/"GeneratedMocks.swift"
    output = <<~SWIFT.gsub(/\s+/, "").strip
      ///
      /// @Generated by Mockolo
      ///
      public class FooMock: Foo {
        public init() { }
        public init(num: Int = 0) {
            self.num = num
        }

        public private(set) var numSetCallCount = 0
        public var num: Int = 0 { didSet { numSetCallCount += 1 } }

        public private(set) var barCallCount = 0
        public var barHandler: ((Float) -> String)?
        public func bar(arg: Float) -> String {
            barCallCount += 1
            if let barHandler = barHandler {
                return barHandler(arg)
            }
            return ""
        }
      }
    SWIFT
    assert_equal output, shell_output("cat #{testpath/"GeneratedMocks.swift"}").gsub(/\s+/, "").strip
  end
end