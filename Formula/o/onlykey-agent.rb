class OnlykeyAgent < Formula
  include Language::Python::Virtualenv

  desc "Middleware that lets you use OnlyKey as a hardware SSHGPG device"
  homepage "https:docs.crp.toonlykey-agent.html"
  url "https:files.pythonhosted.orgpackages6880e89b6c3680bedb1e14e99f0539ac805bddc7d8dd87c58805c64484966b7conlykey-agent-1.1.15.tar.gz"
  sha256 "49b19bec28dc0fb7053ef01266d8a9e7a078bb146214a641bdbb1feac6fc7ddb"
  license "LGPL-3.0-only"

  bottle do
    rebuild 4
    sha256 cellar: :any,                 arm64_sonoma:   "71bf0b37167526b51100cdd52e9f36f2a1be269eb9905c85022272bc0c8e07e5"
    sha256 cellar: :any,                 arm64_ventura:  "a5784d781a7aba1f9a2dcdfbcc0c039b7c853d2c4d93293653d3100e0d2c3dbb"
    sha256 cellar: :any,                 arm64_monterey: "b5158439cb3c529f37f3163f9968a15023d2e312f3b754627a8d531da412d83a"
    sha256 cellar: :any,                 sonoma:         "f1c80f56ae8cd8c2e2f33c1fb86067706f2cc1260725816e7739bc3abfda1a4c"
    sha256 cellar: :any,                 ventura:        "bac4962637f0d4da2517e6af3f6b3c6437ab059dbad18b70a04b73435e3afd25"
    sha256 cellar: :any,                 monterey:       "8d1b85a3339d001293c9181d02bf217876ce861ff41dc5778a6c2a8ab06c41a4"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "f9408817bcedd63b545ec65f4309bd344ff4bec4df6400c9ea83907cf9d88912"
  end

  depends_on "gnupg"
  depends_on "hidapi"
  depends_on "libcython"
  depends_on "libusb"
  depends_on "python-certifi"
  depends_on "python-cryptography"
  depends_on "python@3.12"

  uses_from_macos "libffi"

  resource "aenum" do
    url "https:files.pythonhosted.orgpackagesd0f833e75863394f42e429bb553e05fda7c59763f0fd6848de847a25b3fbccf6aenum-3.1.15.tar.gz"
    sha256 "8cbd76cd18c4f870ff39b24284d3ea028fbe8731a58df3aa581e434c575b9559"
  end

  resource "backports-shutil-which" do
    url "https:files.pythonhosted.orgpackagesa02251b896a4539f1bff6a7ab8514eb031b9f43f12bff23f75a4c3f4e9a666e5backports.shutil_which-3.5.2.tar.gz"
    sha256 "fe39f567cbe4fad89e8ac4dbeb23f87ef80f7fe8e829669d0221ecdb0437c133"
  end

  resource "bech32" do
    url "https:files.pythonhosted.orgpackagesabfeb67ac9b123e25a3c1b8fc3f3c92648804516ab44215adb165284e024c43fbech32-1.2.0.tar.gz"
    sha256 "7d6db8214603bd7871fcfa6c0826ef68b85b0abd90fa21c285a9c5e21d2bd899"
  end

  resource "charset-normalizer" do
    url "https:files.pythonhosted.orgpackages2a53cf0a48de1bdcf6ff6e1c9a023f5f523dfe303e4024f216feac64b6eb7f67charset-normalizer-3.2.0.tar.gz"
    sha256 "3bb3d25a8e6c0aedd251753a79ae98a093c7e7b471faa3aa9a93a81431987ace"
  end

  resource "cffi" do
    url "https:files.pythonhosted.orgpackages68ce95b0bae7968c65473e1298efb042e10cafc7bafc14d9e4f154008241c91dcffi-1.16.0.tar.gz"
    sha256 "bcb3ef43e58665bbda2fb198698fcae6776483e0c4a631aa5647806c25e02cc0"
  end

  resource "click" do
    url "https:files.pythonhosted.orgpackages72bdfedc277e7351917b6c4e0ac751853a97af261278a4c7808babafa8ef2120click-8.1.6.tar.gz"
    sha256 "48ee849951919527a045bfe3bf7baa8a959c423134e1a5b98c05c20ba75a1cbd"
  end

  resource "configargparse" do
    url "https:files.pythonhosted.orgpackages3cfbbf200c55a1e7014577c37fa9cbfa0148f629762bb3acff56299d8c58cbc3ConfigArgParse-1.5.5.tar.gz"
    sha256 "363d80a6d35614bd446e2f2b1b216f3b33741d03ac6d0a92803306f40e555b58"
  end

  resource "docutils" do
    url "https:files.pythonhosted.orgpackages1f53a5da4f2c5739cf66290fac1431ee52aff6851c7c8ffd8264f13affd7bcdddocutils-0.20.1.tar.gz"
    sha256 "f08a4e276c3a1583a86dce3e34aba3fe04d02bba2dd51ed16106244e8a923e3b"
  end

  resource "ecdsa" do
    url "https:files.pythonhosted.orgpackagesff7bba6547a76c468a0d22de93e89ae60d9561ec911f59532907e72b0d8bc0f1ecdsa-0.18.0.tar.gz"
    sha256 "190348041559e21b22a1d65cee485282ca11a6f81d503fddb84d5017e9ed1e49"
  end

  resource "fido2" do
    url "https:files.pythonhosted.orgpackages746e58e1bb40a284291ab483d00831c5b91fe14d498a3ae7c658f3c588658e4bfido2-0.9.3.tar.gz"
    sha256 "b45e89a6109cfcb7f1bb513776aa2d6408e95c4822f83a253918b944083466ec"
  end

  resource "hidapi" do
    url "https:files.pythonhosted.orgpackages950ec106800c94219ec3e6b483210e91623117bfafcf1decaff3c422e18af349hidapi-0.14.0.tar.gz"
    sha256 "a7cb029286ced5426a381286526d9501846409701a29c2538615c3d1a612b8be"

    # patch to build with Cython 3+, remove in next release
    patch do
      url "https:github.comtrezorcython-hidapicommit749da6931f57c4c30596de678125648ccfd6e1cd.patch?full_index=1"
      sha256 "e3d70eb9850c7be0fdb0c31bf575b33be5c5848def904760a6ca9f4c3824f000"
    end
  end

  resource "idna" do
    url "https:files.pythonhosted.orgpackages8be143beb3d38dba6cb420cefa297822eac205a277ab43e5ba5d5c46faf96438idna-3.4.tar.gz"
    sha256 "814f528e8dead7d329833b91c5faa87d60bf71824cd12a7530b5526063d02cb4"
  end

  resource "intelhex" do
    url "https:files.pythonhosted.orgpackages66371e7522494557d342a24cb236e2aec5d078fac8ed03ad4b61372586406b01intelhex-2.3.0.tar.gz"
    sha256 "892b7361a719f4945237da8ccf754e9513db32f5628852785aea108dcd250093"
  end

  resource "lib-agent" do
    url "https:files.pythonhosted.orgpackages9665453f7b077b55610ad46a7018027af44d39e3affa56950d67dc1fdbfdc622lib-agent-1.0.6.tar.gz"
    sha256 "22b262cc81c320f1e8e2d55db946adeeedf5cc7a3736df2070c3b2514aa436ed"
  end

  resource "lockfile" do
    url "https:files.pythonhosted.orgpackages174772cb04a58a35ec495f96984dddb48232b551aafb95bde614605b754fe6f7lockfile-0.12.2.tar.gz"
    sha256 "6aed02de03cba24efabcd600b30540140634fc06cfa603822d508d5361e9f799"
  end

  resource "mnemonic" do
    url "https:files.pythonhosted.orgpackagesf88dd4dc2b2bddfeb57cab4404a41749b577f578f71140ab754da9afa8f5c599mnemonic-0.20.tar.gz"
    sha256 "7c6fb5639d779388027a77944680aee4870f0fcd09b1e42a5525ee2ce4c625f6"
  end

  resource "onlykey" do
    url "https:files.pythonhosted.orgpackages95275bf7048f6d9de97610b6252b392a6d2d7e929dcd82809b973aebf1727114onlykey-1.2.10.tar.gz"
    sha256 "666427c99c7d625208c4c31d674536cdbf9000d7dcc2bb46ee24752e98339814"
  end

  resource "onlykey-solo-python" do
    url "https:files.pythonhosted.orgpackagesf5aada868b3a695ed2de3ffd71455a8269e031fd478957e888028480f7331c6bonlykey-solo-python-0.0.32.tar.gz"
    sha256 "f3c0ee8605f8142c3320acf0e11a9680cb6345d7f986e5652841c00049a29ee4"
  end

  resource "prompt-toolkit" do
    url "https:files.pythonhosted.orgpackages9a0276cadde6135986dc1e82e2928f35ebeb5a1af805e2527fe466285593a2baprompt_toolkit-3.0.39.tar.gz"
    sha256 "04505ade687dc26dc4284b1ad19a83be2f2afe83e7a828ace0c72f3a1df72aac"
  end

  resource "pycparser" do
    url "https:files.pythonhosted.orgpackages5e0b95d387f5f4433cb0f53ff7ad859bd2c6051051cebbb564f139a999ab46depycparser-2.21.tar.gz"
    sha256 "e644fdec12f7872f86c58ff790da456218b10f863970249516d60a5eaca77206"
  end

  resource "pycryptodome" do
    url "https:files.pythonhosted.orgpackagesb9050e7547c445bbbc96c538d870e6c5c5a69a9fa5df0a9df3e27cb126527196pycryptodome-3.18.0.tar.gz"
    sha256 "c9adee653fc882d98956e33ca2c1fb582e23a8af7ac82fee75bd6113c55a0413"
  end

  resource "pymsgbox" do
    url "https:files.pythonhosted.orgpackages7dff4c6f31a4f08979f12a663f2aeb6c8b765d3bd592e66eaaac445f547bb875PyMsgBox-1.0.9.tar.gz"
    sha256 "2194227de8bff7a3d6da541848705a155dcbb2a06ee120d9f280a1d7f51263ff"
  end

  resource "pynacl" do
    url "https:files.pythonhosted.orgpackagesa72227582568be639dfe22ddb3902225f91f2f17ceff88ce80e4db396c8986daPyNaCl-1.5.0.tar.gz"
    sha256 "8ac7448f09ab85811607bdd21ec2464495ac8b7c66d146bf545b0f08fb9220ba"
  end

  resource "pyserial" do
    url "https:files.pythonhosted.orgpackages1e7dae3f0a63f41e4d2f6cb66a5b57197850f919f59e558159a4dd3a818f5082pyserial-3.5.tar.gz"
    sha256 "3c77e014170dfffbd816e6ffc205e9842efb10be9f58ec16d3e8675b4925cddb"
  end

  resource "python-daemon" do
    url "https:files.pythonhosted.orgpackages845097b81327fccbb70eb99f3c95bd05a0c9d7f13fb3f4cfd975885110d1205apython-daemon-3.0.1.tar.gz"
    sha256 "6c57452372f7eaff40934a1c03ad1826bf5e793558e87fef49131e6464b4dae5"
  end

  resource "pyusb" do
    url "https:files.pythonhosted.orgpackagesd96e433a5614132576289b8643fe598dd5d51b16e130fd591564be952e15bb45pyusb-1.2.1.tar.gz"
    sha256 "a4cc7404a203144754164b8b40994e2849fde1cfff06b08492f12fff9d9de7b9"
  end

  resource "requests" do
    url "https:files.pythonhosted.orgpackages9dbe10918a2eac4ae9f02f6cfe6414b7a155ccd8f7f9d4380d62fd5b955065c3requests-2.31.0.tar.gz"
    sha256 "942c5a758f98d790eaed1a29cb6eefc7ffb0d1cf7af05c3d2791656dbd6ad1e1"
  end

  resource "semver" do
    url "https:files.pythonhosted.orgpackages4630a14b56e500e8eabf8c349edd0583d736b231e652b7dce776e85df11e9e0bsemver-3.0.1.tar.gz"
    sha256 "9ec78c5447883c67b97f98c3b6212796708191d22e4ad30f4570f840171cbce1"
  end

  resource "six" do
    url "https:files.pythonhosted.orgpackages7139171f1c67cd00715f190ba0b100d606d440a28c93c7714febeca8b79af85esix-1.16.0.tar.gz"
    sha256 "1e61c37477a1626458e36f7b1d82aa5c9b094fa4802892072e49de9c60c4c926"
  end

  resource "unidecode" do
    url "https:files.pythonhosted.orgpackages0b2537c77fc07821cd06592df3f18281f5e716bc891abd6822ddb9ff941f821eUnidecode-1.3.6.tar.gz"
    sha256 "fed09cf0be8cf415b391642c2a5addfc72194407caee4f98719e40ec2a72b830"
  end

  resource "urllib3" do
    url "https:files.pythonhosted.orgpackages31ab46bec149bbd71a4467a3063ac22f4486ecd2ceb70ae8c70d5d8e4c2a7946urllib3-2.0.4.tar.gz"
    sha256 "8d22f86aae8ef5e410d4f539fde9ce6b2113a001bb4d189e0aed70642d602b11"
  end

  resource "wcwidth" do
    url "https:files.pythonhosted.orgpackages5e5f1e4bd82a9cc1f17b2c2361a2d876d4c38973a997003ba5eb400e8a932b6cwcwidth-0.2.6.tar.gz"
    sha256 "a5220780a404dbe3353789870978e472cfe477761f06ee55077256e509b156d0"
  end

  resource "wheel" do
    url "https:files.pythonhosted.orgpackagesfcef0335f7217dd1e8096a9e8383e1d472aa14717878ffe07c4772e68b6e8735wheel-0.40.0.tar.gz"
    sha256 "cd1196f3faee2b31968d626e1731c94f99cbdb67cf5a46e4f5656cbee7738873"
  end

  def python3
    "python3.12"
  end

  def install
    # prevent "fatal error: libusb.h: No such file or directory" when building hidapi on linux
    ENV.append_to_cflags "-I#{Formula["libusb"].include}libusb-1.0"
    # replacement for virtualenv_install_with_resources per https:docs.brew.shPython-for-Formula-Authors
    venv = virtualenv_create(libexec, python3)
    # build hidapi
    resource("hidapi").stage do
      # monkey patch hidapi's include paths to be the homebrew-installed path instead
      # TODO: Fix this with an upstream patch to support `--with-system-hidapi=foobarhidapi`
      #       per https:github.comHomebrewhomebrew-corepull104096#discussion_r919469723
      inreplace "setup.py" do |s|
        s.gsub! "usrincludelibusb-1.0", "#{Formula["libusb"].opt_include}libusb-1.0"
        s.gsub! "usrincludehidapi", "#{Formula["hidapi"].opt_include}hidapi"
      end
      system python3, *Language::Python.setup_install_args(libexec, python3), "--with-system-hidapi"
    end
    # now have pip build other resources except hidapi:
    venv.pip_install resources.reject { |r| r.name == "hidapi" }
    venv.pip_install_and_link buildpath

    # add path configuration file to find cython
    site_packages = Language::Python.site_packages(python3)
    pth_contents = <<~EOS
      import site; site.addsitedir('#{Formula["libcython"].opt_libexecsite_packages}')
    EOS
    (libexecsite_packages"homebrew-onlykey-agent.pth").write pth_contents
  end

  test do
    # the device mut not be plugged in to get the expected message
    # since CI is the foremost user of `brew test` we assume that there is no device
    output = shell_output("#{bin}onlykey-agent test@example.com 2>&1", 1)
    assert_match("try unplugging and replugging your device", output)
  end
end