class Uv < Formula
  desc "Extremely fast Python package installer and resolver, written in Rust"
  homepage "https://docs.astral.sh/uv/"
  url "https://ghfast.top/https://github.com/astral-sh/uv/archive/refs/tags/0.8.11.tar.gz"
  sha256 "8234ce9824a2ea576f261875df6266a266a40bab0be3100d374c35ae278eee8f"
  license any_of: ["Apache-2.0", "MIT"]
  head "https://github.com/astral-sh/uv.git", branch: "main"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sequoia: "1029001fa24969ad08c98b17d596173d1cec8bfcb3df3bb5e8c4ba159997ee76"
    sha256 cellar: :any_skip_relocation, arm64_sonoma:  "712aee0a7c9bcc32778e4be1befdebeb174c6de525a2ee532dd4185ce76289cf"
    sha256 cellar: :any_skip_relocation, arm64_ventura: "547eda5669a9a00153dbc523362e26a6f48a1588d4e4b69662c2fa5b12e50135"
    sha256 cellar: :any_skip_relocation, sonoma:        "70622a235dc256fb7e63dcee3de5579ce52f82aa557bebaf5c241f4168c8d2f4"
    sha256 cellar: :any_skip_relocation, ventura:       "e2c5bb240c3ae7495b1cf807e3c15bc919f4897d23db15b6d7b70b9150dce559"
    sha256 cellar: :any_skip_relocation, arm64_linux:   "05833494f9a4f85a6f188b1bfc33e8ee01c5a1069f97a7822bf1cd02177520fd"
    sha256 cellar: :any_skip_relocation, x86_64_linux:  "d4da54edfcfb6ec5b99dc816713f3dcb58a3e877f382d7ef2310af0504ab3cab"
  end

  depends_on "pkgconf" => :build
  depends_on "rust" => :build

  uses_from_macos "python" => :test
  uses_from_macos "bzip2"
  uses_from_macos "xz"

  def install
    ENV["UV_COMMIT_HASH"] = ENV["UV_COMMIT_SHORT_HASH"] = tap.user
    ENV["UV_COMMIT_DATE"] = time.strftime("%F")
    system "cargo", "install", *std_cargo_args(path: "crates/uv")
    generate_completions_from_executable(bin/"uv", "generate-shell-completion")
    generate_completions_from_executable(bin/"uvx", "--generate-shell-completion")
  end

  test do
    (testpath/"requirements.in").write <<~REQUIREMENTS
      requests
    REQUIREMENTS

    compiled = shell_output("#{bin}/uv pip compile -q requirements.in")
    assert_match "This file was autogenerated by uv", compiled
    assert_match "# via requests", compiled

    assert_match "ruff 0.5.1", shell_output("#{bin}/uvx -q ruff@0.5.1 --version")
  end
end