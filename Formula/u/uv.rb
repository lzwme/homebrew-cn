class Uv < Formula
  desc "Extremely fast Python package installer and resolver, written in Rust"
  homepage "https:github.comastral-shuv"
  url "https:github.comastral-shuvarchiverefstags0.4.2.tar.gz"
  sha256 "8d1b1078b33ad3373b378d70ab3a24f43218b1497e0aee7ec66f3fde0db41ac5"
  license any_of: ["Apache-2.0", "MIT"]
  head "https:github.comastral-shuv.git", branch: "main"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sonoma:   "1bbb3b462d0eb39ecc5c6546b41b64fce9a897677ef993099c6ab07ccbd8463c"
    sha256 cellar: :any_skip_relocation, arm64_ventura:  "0c295d4aa6eaedd2724a809d3b4c2f5cb47850316574362ebc99df1b85e7b12c"
    sha256 cellar: :any_skip_relocation, arm64_monterey: "5517bd192da4dcf9b307b180de853b407ef62532e8f7b2692017a13a64e5755e"
    sha256 cellar: :any_skip_relocation, sonoma:         "e952e076bae0137a03e0fa7633abd7eab079b6343bd7595315d8dffc8ec2cc6c"
    sha256 cellar: :any_skip_relocation, ventura:        "f508b053b594be3a22afce6e8ad0a30d5c32ee3006c8131f9e8b3747ab891a7c"
    sha256 cellar: :any_skip_relocation, monterey:       "963cce185e64dd5a64e4967b248e43eab8fe93f753c8f9a4361c544518b75a5a"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "14700db2074e6f719ce6162dd28fe65e5c31b1e1faffcd8fd52dc1fd6c1ae9c3"
  end

  depends_on "pkg-config" => :build
  depends_on "rust" => :build

  uses_from_macos "python" => :test
  uses_from_macos "xz"

  on_linux do
    # On macOS, bzip2-sys will use the bundled lib as it cannot find the system or brew lib.
    # We only ship bzip2.pc on Linux which bzip2-sys needs to find library.
    depends_on "bzip2"
  end

  def install
    ENV["UV_COMMIT_HASH"] = ENV["UV_COMMIT_SHORT_HASH"] = tap.user
    ENV["UV_COMMIT_DATE"] = time.strftime("%F")
    system "cargo", "install", "--no-default-features", *std_cargo_args(path: "cratesuv")
    generate_completions_from_executable(bin"uv", "generate-shell-completion")
  end

  test do
    (testpath"requirements.in").write <<~EOS
      requests
    EOS

    compiled = shell_output("#{bin}uv pip compile -q requirements.in")
    assert_match "This file was autogenerated by uv", compiled
    assert_match "# via requests", compiled

    assert_match "ruff 0.5.1", shell_output("#{bin}uvx -q ruff@0.5.1 --version")
  end
end