class Uv < Formula
  desc "Extremely fast Python package installer and resolver, written in Rust"
  homepage "https://docs.astral.sh/uv/"
  url "https://ghfast.top/https://github.com/astral-sh/uv/archive/refs/tags/0.8.12.tar.gz"
  sha256 "b6f86b547ea3744ffd14f14f07ccdfb60528ce7396a454a65ad72556272a0e67"
  license any_of: ["Apache-2.0", "MIT"]
  head "https://github.com/astral-sh/uv.git", branch: "main"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sequoia: "125607f10877b01f1ab3df6093bf301057ce5c020ffe121eb829ffc621c617c9"
    sha256 cellar: :any_skip_relocation, arm64_sonoma:  "4bba3b9f07cc01e9aa45b218b120e0d89b380eefce97bd5f905166dc82f8d9e2"
    sha256 cellar: :any_skip_relocation, arm64_ventura: "ad8503ecc440b956a5bcff2428909664c9141763afe558058a6b3f400779ebaf"
    sha256 cellar: :any_skip_relocation, sonoma:        "74c946fcb9653dddda2f9d29568da7c74d1ea48b23a6ca34d9d6b119fcee8d52"
    sha256 cellar: :any_skip_relocation, ventura:       "658d854b6beb32392d351cd37dbd8ed16b15d4e2067f4bd6c23f45410bdc8ec6"
    sha256 cellar: :any_skip_relocation, arm64_linux:   "72874cc8a166e86cfba24a04ecdcc831bdc601561f1574e4fcb21054525eb0ba"
    sha256 cellar: :any_skip_relocation, x86_64_linux:  "4db7ae91987a77df00029e8e0a61836241500e312df3f4a06e483dc94c69a200"
  end

  depends_on "pkgconf" => :build
  depends_on "rust" => :build

  uses_from_macos "python" => :test
  uses_from_macos "bzip2"
  uses_from_macos "xz"

  def install
    ENV["UV_COMMIT_HASH"] = ENV["UV_COMMIT_SHORT_HASH"] = tap.user
    ENV["UV_COMMIT_DATE"] = time.strftime("%F")
    system "cargo", "install", *std_cargo_args(path: "crates/uv")
    generate_completions_from_executable(bin/"uv", "generate-shell-completion")
    generate_completions_from_executable(bin/"uvx", "--generate-shell-completion")
  end

  test do
    (testpath/"requirements.in").write <<~REQUIREMENTS
      requests
    REQUIREMENTS

    compiled = shell_output("#{bin}/uv pip compile -q requirements.in")
    assert_match "This file was autogenerated by uv", compiled
    assert_match "# via requests", compiled

    assert_match "ruff 0.5.1", shell_output("#{bin}/uvx -q ruff@0.5.1 --version")
  end
end