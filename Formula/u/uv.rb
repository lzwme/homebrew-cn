class Uv < Formula
  desc "Extremely fast Python package installer and resolver, written in Rust"
  homepage "https:github.comastral-shuv"
  url "https:github.comastral-shuvarchiverefstags0.3.3.tar.gz"
  sha256 "2300fdb5e463bd1a342e301a74cfcdcdc9745bd6d6a11c49f7d75fdd5ef5d20a"
  license any_of: ["Apache-2.0", "MIT"]
  head "https:github.comastral-shuv.git", branch: "main"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sonoma:   "a5bac509af1557b0a5791237881aa338ad5022c4745ae7bc4f50e14ed062ef74"
    sha256 cellar: :any_skip_relocation, arm64_ventura:  "3e7f6baf66e221244b08c66f3d0820c8f2415d38a9efbbe30a25f6d0de21d772"
    sha256 cellar: :any_skip_relocation, arm64_monterey: "7b0376db6b6d51e79c3a32b80b43aec6fd240ce31c3277722d4a8c269ca6ea0c"
    sha256 cellar: :any_skip_relocation, sonoma:         "6fd82422f0b6b99fe61290747293383770829b05bbbabc36e6307a68130bb2e3"
    sha256 cellar: :any_skip_relocation, ventura:        "bf9a3515eef5d5c17cda9c4c409f61bbcf4bfd1dea471dc302be9ea48f9b2273"
    sha256 cellar: :any_skip_relocation, monterey:       "a769ccba4d184c08690a346d3195682242fa8b2deb0f05eea62aa2b1eb96070e"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "5e22564363e3d45ddb662b30779a55b0ad71ee7de5f0284a19f24139875a539a"
  end

  depends_on "pkg-config" => :build
  depends_on "rust" => :build

  uses_from_macos "python" => :test
  uses_from_macos "xz"

  on_linux do
    # On macOS, bzip2-sys will use the bundled lib as it cannot find the system or brew lib.
    # We only ship bzip2.pc on Linux which bzip2-sys needs to find library.
    depends_on "bzip2"
  end

  def install
    ENV["UV_COMMIT_HASH"] = ENV["UV_COMMIT_SHORT_HASH"] = tap.user
    ENV["UV_COMMIT_DATE"] = time.strftime("%F")
    system "cargo", "install", "--no-default-features", *std_cargo_args(path: "cratesuv")
    generate_completions_from_executable(bin"uv", "generate-shell-completion")
  end

  test do
    (testpath"requirements.in").write <<~EOS
      requests
    EOS

    compiled = shell_output("#{bin}uv pip compile -q requirements.in")
    assert_match "This file was autogenerated by uv", compiled
    assert_match "# via requests", compiled

    assert_match "ruff 0.5.1", shell_output("#{bin}uvx -q ruff@0.5.1 --version")
  end
end