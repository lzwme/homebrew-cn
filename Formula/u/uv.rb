class Uv < Formula
  desc "Extremely fast Python package installer and resolver, written in Rust"
  homepage "https:github.comastral-shuv"
  url "https:github.comastral-shuvarchiverefstags0.2.12.tar.gz"
  sha256 "4f2d50b144e581f8cecf002d5ef0f716477fc95401353e447c9107611df203e1"
  license any_of: ["Apache-2.0", "MIT"]
  head "https:github.comastral-shuv.git", branch: "main"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sonoma:   "6a49c79c3940b3bc72c54dd95d948f309a49e1ddb33e57fabc0328e74a5b81bb"
    sha256 cellar: :any_skip_relocation, arm64_ventura:  "d664f7883a18829eb180531f49ca48660cdfa8ca86f8c1518234c7f52f689b67"
    sha256 cellar: :any_skip_relocation, arm64_monterey: "78e6a5d0db7e6e1762297f7f0c4c9eb347e05b5a009a6d46408ebbe9abbc5a37"
    sha256 cellar: :any_skip_relocation, sonoma:         "7121f624d39981fd70f1b28b9083d13ecdc9b8748d061c0afdc4a3ade7e030d7"
    sha256 cellar: :any_skip_relocation, ventura:        "28e804adfcc316c3e310953f4f3502fcae21772c1fd4144285239f20dbfcb578"
    sha256 cellar: :any_skip_relocation, monterey:       "e006952f15140f3a515985129b46bb4b10514f5c86b06b0506dddd714f4d3692"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "135ca3a0531575a3cd3728454a3878c181e35e8213b8847e930641154d51db3c"
  end

  depends_on "pkg-config" => :build
  depends_on "rust" => :build

  uses_from_macos "python" => :test

  on_linux do
    # On macOS, bzip2-sys will use the bundled lib as it cannot find the system or brew lib.
    # We only ship bzip2.pc on Linux which bzip2-sys needs to find library.
    depends_on "bzip2"
  end

  def install
    system "cargo", "install", "--no-default-features", *std_cargo_args(path: "cratesuv")
    generate_completions_from_executable(bin"uv", "generate-shell-completion")
  end

  test do
    (testpath"requirements.in").write <<~EOS
      requests
    EOS

    compiled = shell_output("#{bin}uv pip compile -q requirements.in")
    assert_match "This file was autogenerated by uv", compiled
    assert_match "# via requests", compiled
  end
end