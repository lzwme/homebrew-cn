class Uv < Formula
  desc "Extremely fast Python package installer and resolver, written in Rust"
  homepage "https://docs.astral.sh/uv/"
  url "https://ghfast.top/https://github.com/astral-sh/uv/archive/refs/tags/0.8.5.tar.gz"
  sha256 "611e2ad9b20f2462bf30632d2d2dc0eae865046e058c8c8f7180ddb0cd4e2b26"
  license any_of: ["Apache-2.0", "MIT"]
  head "https://github.com/astral-sh/uv.git", branch: "main"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sequoia: "25090425a7f9ebd2f51cc3db975a1659642249309bd099e621d4b2e3591bc80c"
    sha256 cellar: :any_skip_relocation, arm64_sonoma:  "e67da003dd6e46344ddb9f3b963662ce0c4d97ddf7462be90734811d83a23846"
    sha256 cellar: :any_skip_relocation, arm64_ventura: "af636e3dc9cf30e113d0b15ade2fa7af529e59ba28f0671207969696f7d12ef6"
    sha256 cellar: :any_skip_relocation, sonoma:        "dbbd1b827676da31b12940ae9783a0e8dc309f4dfc362df8273f511f2ac7b337"
    sha256 cellar: :any_skip_relocation, ventura:       "997678c6b430b03010ddda525adf65c08a07ad2cf1f62fd0d0925f27f8d24a21"
    sha256 cellar: :any_skip_relocation, arm64_linux:   "d11b8cc655e8bd4e5ec443c82440d83c7a6e35b71af3b6b6d126612b763beb0d"
    sha256 cellar: :any_skip_relocation, x86_64_linux:  "0de0b02d50374f714550384cfd087ca131158aa17587720d3a4aa2b9159a25c2"
  end

  depends_on "pkgconf" => :build
  depends_on "rust" => :build

  uses_from_macos "python" => :test
  uses_from_macos "bzip2"
  uses_from_macos "xz"

  def install
    ENV["UV_COMMIT_HASH"] = ENV["UV_COMMIT_SHORT_HASH"] = tap.user
    ENV["UV_COMMIT_DATE"] = time.strftime("%F")
    system "cargo", "install", *std_cargo_args(path: "crates/uv")
    generate_completions_from_executable(bin/"uv", "generate-shell-completion")
    generate_completions_from_executable(bin/"uvx", "--generate-shell-completion")
  end

  test do
    (testpath/"requirements.in").write <<~REQUIREMENTS
      requests
    REQUIREMENTS

    compiled = shell_output("#{bin}/uv pip compile -q requirements.in")
    assert_match "This file was autogenerated by uv", compiled
    assert_match "# via requests", compiled

    assert_match "ruff 0.5.1", shell_output("#{bin}/uvx -q ruff@0.5.1 --version")
  end
end