class Uv < Formula
  desc "Extremely fast Python package installer and resolver, written in Rust"
  homepage "https:github.comastral-shuv"
  url "https:github.comastral-shuvarchiverefstags0.5.4.tar.gz"
  sha256 "3c1c95bcc99930b929e18665d7691b219ce4bef3555711a9be80139c183b9595"
  license any_of: ["Apache-2.0", "MIT"]
  head "https:github.comastral-shuv.git", branch: "main"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sequoia: "690bead24b3e885611e6d62f40152811d12865a03ad094c1528b19defa3a5eab"
    sha256 cellar: :any_skip_relocation, arm64_sonoma:  "5eecc61149326e379504c16ababcaf1ba89d1d00d98cf3e2d6eab46dcb9de222"
    sha256 cellar: :any_skip_relocation, arm64_ventura: "06fa10a4364f783dd12717942eafe84b7a91284f188a45f723ea102695c6e179"
    sha256 cellar: :any_skip_relocation, sonoma:        "5ba8acb4409924ff8143af31abcc5a41d6dd064c2782afca3bda7940797e7154"
    sha256 cellar: :any_skip_relocation, ventura:       "3038650d2eb526411c83cfe55716cdd57959a93af0bcb5438075b5dda15e4507"
    sha256 cellar: :any_skip_relocation, x86_64_linux:  "c81cdb8fd4db86bc01b3452375f6d5fc7e7d1126fa00ed328ccb50d4f6f6ab6c"
  end

  depends_on "pkg-config" => :build
  depends_on "rust" => :build

  uses_from_macos "python" => :test
  uses_from_macos "bzip2"
  uses_from_macos "xz"

  def install
    ENV["UV_COMMIT_HASH"] = ENV["UV_COMMIT_SHORT_HASH"] = tap.user
    ENV["UV_COMMIT_DATE"] = time.strftime("%F")
    system "cargo", "install", "--no-default-features", *std_cargo_args(path: "cratesuv")
    generate_completions_from_executable(bin"uv", "generate-shell-completion")
    generate_completions_from_executable(bin"uvx", "--generate-shell-completion", base_name: "uvx")
  end

  test do
    (testpath"requirements.in").write <<~EOS
      requests
    EOS

    compiled = shell_output("#{bin}uv pip compile -q requirements.in")
    assert_match "This file was autogenerated by uv", compiled
    assert_match "# via requests", compiled

    assert_match "ruff 0.5.1", shell_output("#{bin}uvx -q ruff@0.5.1 --version")
  end
end