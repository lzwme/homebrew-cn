class GoLibrespot < Formula
  desc "Spotify client"
  homepage "https://github.com/devgianlu/go-librespot"
  url "https://ghfast.top/https://github.com/devgianlu/go-librespot/archive/refs/tags/v0.4.0.tar.gz"
  sha256 "f11d45b42d548273aac32ce9ca9b0aba95c1660b7ce35950529906973e861b6f"
  license "GPL-3.0-only"
  head "https://github.com/devgianlu/go-librespot.git", branch: "master"

  bottle do
    sha256 cellar: :any,                 arm64_tahoe:   "720882a2b37267cfb3a5fa0acfede3bac6ff879dc94045b966684540db119590"
    sha256 cellar: :any,                 arm64_sequoia: "57bad485ac3a683724c866f745aa9afd2e53e394b89b7dc1103635dd7217cffb"
    sha256 cellar: :any,                 arm64_sonoma:  "8dec4a129849d925dd95be6a5ee3ac057efe1cf32723233988867e2d759ce18a"
    sha256 cellar: :any,                 arm64_ventura: "d085a4bad8cc29d96b88aac8e33589d838d3d82c7ea79a77416a3a330fea6689"
    sha256 cellar: :any,                 sonoma:        "1ba6aafbe626288471527d4fc1d24b1682bda804acaac6b0e67b885d71b1c515"
    sha256 cellar: :any,                 ventura:       "6f91701bf928a2dc9d89b29d097a66f864fdf47e8744d7c5802e9d0097fb6223"
    sha256 cellar: :any_skip_relocation, arm64_linux:   "3d51333fc239b2cc634060a12be740ef827de37fa64be51c3ddc5173fa85243b"
    sha256 cellar: :any_skip_relocation, x86_64_linux:  "4acf94cbc92c65d05fab915c743f8c1feb508b7fe223472cec7f9670ea711608"
  end

  depends_on "go" => :build
  depends_on "pkgconf" => :build
  depends_on "libogg"
  depends_on "libvorbis"

  on_linux do
    depends_on "alsa-lib"
  end

  def install
    ldflags = %W[
      -s -w
      -X github.com/devgianlu/go-librespot.version=#{version}
    ]
    ldflags << "-X github.com/devgianlu/go-librespot.commit=#{Utils.git_short_head(length: 8)}" if build.head?

    system "go", "build", *std_go_args(output: bin/"go-librespot", ldflags: ldflags), "./cmd/daemon"

    # On macOS, create a minimal config that selects the correct backend.
    return unless OS.mac?

    (buildpath/"config.yml").write <<~YAML
      # Auto-generated by Homebrew. You can edit this file.
      # Use CoreAudio via AudioToolbox on macOS.
      audio_backend: audio-toolbox
    YAML
    pkgetc.install "config.yml"
  end

  def post_install
    (var/"log").mkpath
  end

  service do
    run [opt_bin/"go-librespot", "--config_dir", etc/"go-librespot"]
    keep_alive true
    log_path var/"log/go-librespot.log"
    error_log_path var/"log/go-librespot.log"
  end

  test do
    cfg = testpath/"config.yml"
    cfg.write <<~YAML
      volume_steps: not_a_number
    YAML

    output = shell_output("#{bin}/go-librespot --config_dir #{testpath} 2>&1", 1)
    assert_match "failed loading config", output
    assert_match "failed to unmarshal configuration", output
  end
end